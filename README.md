# grunt-awsebtdeploy

> A grunt plugin to deploy applications to AWS Elastic Beanstalk

This plugin automates uploading an application _sourceBundle_ to S3 and update an Elastic Beanstalk
environment with the new version of your application.

## Getting Started

This plugin requires Grunt `~0.4.4`

If you haven't used [Grunt](http://gruntjs.com/) before, be sure to check out the [Getting Started](http://gruntjs.com/getting-started) guide, as it explains how to create a [Gruntfile](http://gruntjs.com/sample-gruntfile) as well as install and use Grunt plugins. Once you're familiar with that process, you may install this plugin with this command:

```shell
npm install grunt-awsebtdeploy --save-dev
```

Once the plugin has been installed, it may be enabled inside your Gruntfile with this line of JavaScript:

```js
grunt.loadNpmTasks('grunt-awsebtdeploy');
```

## Deployment types

Several deployment types are supported, which can be configured in the task options.  
There is a common sequence of operations followed by all deployment types, which correspond to 
[AWS SDK operations](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/frames.html).

1. `describeApplications` to check that `options.applicationName` exists
2. `describeEnvironments` to check that `options.environmentCNAME` exists
3. `S3.putObject` to upload `options.sourceBundle` to S3
4. `createApplicationVersion` to create a new application version from the S3 object
5. [any deployment type-specific logic, described below]

### inPlace

The deploy is done to the currently running environment, therefore a downtime will happen while the
environment refreshes after the update.

The specific operations are:

1. `updateEnvironment` to configure the environment to use the new application version
2. `describeEnvironments` recursively to check that the existing environment is up and running

> This deployment type is safe for non-production environments where there is no need to guarantee uptime

### swapToNew 

A flavor of *blue/green* deployment where a new environment is created with the same settings as the current one, 
the application is deployed to the new environment and finally the CNAMEs of the environments are swapped 
so that the old environment url now points to the new one. 
This method enables zero-downtime deployments and the procedure 
is described in the [AWS documentation](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.CNAMESwap.html).

> The old environment is not terminated automatically for safety reasons, to avoid leaving old environments running
they should be terminated manually.  
> Creating a new environment is a lengthy operation that may take up to several minutes

The specific operations are:

1. `createConfigurationTemplate` to create a template of the configuration of the current environment to be used for 
the new environment. The template is given an autogenerated name
2. `createEnvironment` to create a new environment based on the previous template, containing the new application version.
The environment is given an autogenerated name
3. `describeEnvironments` recursively to check that the new environment is up and running
4. `swapEnvironmentCNAMEs` to swap the urls of the old and new environments so that the new environment starts responding
to requests made to the old environment url

> This deployment type is more appropriate for production environments, but compared to `inPlace` it creates new resources and can potentially disrupt the functionality of the environment in case any step goes wrong, which would require manual intervention, for example to swap CNAMEs again to the old, untouched environment    


## The **awsebtdeploy** task

### Overview
In your project's Gruntfile, add a section named `awsebtdeploy` to the data object passed into `grunt.initConfig()`.

```js
grunt.initConfig({
  awsebtdeploy: {
    options: {
      // Task-specific options go here.
    },
    your_target: {
      // Target-specific options go here.
    },
  },
});
```

### Options

These are the supported options. A trailing __*__ indicates a mandatory option.

##### options.applicationName *

* Type: `String` 

The name of the Elastic Beanstalk application.  
It must exist and be accessible with the provided authorization tokens, otherwise an error is raised.

##### options.environmentCNAME *

* Type: `String` 

The CNAME of the Elastic Beanstalk environment.
This is the url normally used to access the application, for example `myapp.elasticbeanstalk.com`.
It must exist and be accessible with the provided authorization tokens, otherwise an error is raised.

##### options.region *

* Type: `String` 

The [AWS region](http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region), for example `us-east-1`.  
This setting applies to all resources handled by the task, S3 and Elastic Beanstalk.

##### options.sourceBundle *

* Type: `String` 

The path to a valid [source bundle](http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.deployment.source.html) 
archive on the local file system.  
The archive needs to be created in advance, for instance with `git archive --format zip`.

##### options.deployType

* Type: `String` 
* Default: `inPlace`  
* Allowed values: `inPlace` | `swapToNew`

The type of the deployment to perform.

##### options.versionLabel 

* Type: `String`
* Default: `options.sourceBundle` file name without the extension

The label of the application version as it appears in Elastic Beanstalk.  

##### options.versionDescription

* Type: `String`
* Default: `""` (empty string)

The description of the application version as it appears in Elastic Beanstalk.

##### options.accessKeyId

* Type: `String`
* Default: `process.env.AWS_ACCESS_KEY_ID`

The AWS access key id.  
If not provided explicitly it is taken from the environment variable, but it needs to be set one way or another.

##### options.secretAccessKey

* Type: `String` 
* Default: `process.env.AWS_SECRET_ACCESS_KEY`

The AWS secret access key.  
If not provided explicitly it is taken from the environment variable, but it needs to be set one way or another.

##### options.s3

* Type: `Object`
* Default: 
```js
{ 
    bucket: options.applicationName,  
    key: path.basename(options.sourceBundle) 
}
```

An object containing the configuration options for the S3 bucket where
`options.sourceBundle` is uploaded.  
It accepts all options as the [AWS S3 SDK
`putObject` operation](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObject-property),
just in _camelCase_ rather than _PascalCase_.

All settings are optional except `bucket` and `key`, which have sensible defaults.

> `bucket` must refer to an existing and accessible bucket

## Usage Examples

```js
grunt.initConfig({
  awsebtdeploy: {
    demo: {
      options: {
        region: 'eu-west-1',
        applicationName: 'awsebtdeploy-demo',
        environmentCNAME: 'awsebtdeploy-demo.elasticbeanstalk.com',
        sourceBundle: "path/to/source/bundle.zip"
        // or via the AWS_ACCESS_KEY_ID environment variable
        accessKeyId: "your access ID",
        // or via the AWS_SECRET_ACCESS_KEY environment variable
        secretAccessKey: "your secret access key",
      }
    }
  }
});
```

#### Setting properties dynamically

A common scenario is to generate option names dynamically, especially for those settings that must be unique in AWS, like object keys in S3 (per bucket) and EBT application versions (per application).

By default the S3 object key as well as the EBT `versionLabel` are derived from `sourceBundle` (its basename only), which means that as long as the file name pointed to by `sourceBundle` does not collide with existing S3 object keys or EBT application versions all is good.  
The rationale behind this design decision is that we imagine that the `sourceBundle` archive is generated using a mechanism similar to:

```shell
git describe [...]
git archive [...]
```

which, depending on the passed flags, can generate meaningful names for the resulting archive.

Once you have a sensible value for `sourceBundle` setting it into the task/target options is a matter of relying on *grunt*, which provides utility functions to set configuration options using a *dotted* notation:

```js
var sourceBundle = 'path/to/source/bundle.zip';
grunt.config('awsebtdeploy.demo.options.sourceBundle', sourceBundle);
```

This snippet of code could be run for example in a custom task before the `awsebtdeploy` task.